image: 253882794486.dkr.ecr.us-east-1.amazonaws.com/build-tools:master-net8

include:
  - project: "fca/architecture/IaC/cloud-digital/common-ci"
    file: "/job-commons.yml"
  - project: 'fca/architecture/IaC/cloud-digital/common-ci'  
    file: 'job-commons-sqube.yml'

variables:
  REPOSITORY_URL: 924431524709.dkr.ecr.us-east-1.amazonaws.com/digital-esb-app-esb-baseproject-esb
  CX_ADDITIONAL_PARAMS: '--threshold "sast-medium=9999; sast-high=9999; sast-critical=9999"'

stages:
  - security
  - build
  - test

before_script:
  - IMAGE_TAG="$(echo $CI_COMMIT_SHA | head -c 8)"
  - VERSION=$(date +"%Y%m%d%H%M")
  - echo $IMAGE_TAG $CI_COMMIT_REF_NAME $VERSION
  - echo $REPOSITORY_URL

test:
  image: mcr.microsoft.com/dotnet/sdk:8.0
  stage: test
  script:
    - mkdir -p ./src/artifacts
    - dotnet test ./src/Application.Tests/Application.Tests.csproj --verbosity normal --logger:"junit;LogFilePath=../artifacts/{assembly}-result.xml;MethodFormat=Class;FailureBodyFormat=Verbose"
    - dotnet test ./src/Domain.Tests/Domain.Tests.csproj --verbosity normal --logger:"junit;LogFilePath=../artifacts/{assembly}-result.xml;MethodFormat=Class;FailureBodyFormat=Verbose"
    - dotnet test ./src/Infrastructure.Tests/Infrastructure.Tests.csproj --verbosity normal --logger:"junit;LogFilePath=../artifacts/{assembly}-result.xml;MethodFormat=Class;FailureBodyFormat=Verbose"
    - dotnet test ./src/WebApi.Tests/WebApi.Tests.csproj --verbosity normal --logger:"junit;LogFilePath=../artifacts/{assembly}-result.xml;MethodFormat=Class;FailureBodyFormat=Verbose"
  artifacts:
    when: always
    paths:
      - ./src/artifacts/*-result.xml
    reports:
      junit:
        - ./src/artifacts/*-result.xml